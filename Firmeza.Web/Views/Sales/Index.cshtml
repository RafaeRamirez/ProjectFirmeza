@model IEnumerable<Firmeza.Web.Models.Sale>
@using Firmeza.Web.Models.ViewModels
@{ ViewData["Title"]="Ventas"; }
@{
    decimal totalAmount = ViewBag.TotalSalesAmount is decimal d ? d : 0m;
    var dailyTotals = ViewBag.DailyTotals as IEnumerable<SalesSummaryItem> ?? Enumerable.Empty<SalesSummaryItem>();
    var monthlyTotals = ViewBag.MonthlyTotals as IEnumerable<SalesSummaryItem> ?? Enumerable.Empty<SalesSummaryItem>();
    var yearlyTotals = ViewBag.YearlyTotals as IEnumerable<SalesSummaryItem> ?? Enumerable.Empty<SalesSummaryItem>();
    string dailyFilter = ViewBag.DailyFilter as string ?? string.Empty;
    string monthlyFilter = ViewBag.MonthlyFilter as string ?? string.Empty;
    string yearlyFilter = ViewBag.YearlyFilter as string ?? string.Empty;
}
@{
    string fromValue = ViewBag.FilterFrom as string ?? "";
    string toValue = ViewBag.FilterTo as string ?? "";
    string filterCustomer = ViewBag.FilterCustomerId as string ?? "";
    string minValue = ViewBag.FilterMinTotal as string ?? "";
    string maxValue = ViewBag.FilterMaxTotal as string ?? "";
    var customers = (ViewBag.Customers as IEnumerable<Firmeza.Web.Models.Customer>) ?? Enumerable.Empty<Firmeza.Web.Models.Customer>();
}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Ventas</h2>
    <div class="d-flex gap-2">
        <a class="btn btn-outline-primary"
           asp-action="Export"
           asp-route-from="@fromValue"
           asp-route-to="@toValue"
           asp-route-customerId="@filterCustomer"
           asp-route-minTotal="@minValue"
           asp-route-maxTotal="@maxValue">Exportar Excel</a>
        <a class="btn btn-success" asp-action="Create">Registrar venta</a>
    </div>
    </div>
</div>

<section class="glass-panel p-4 mb-4">
    <div class="row g-4">
        <div class="col-md-4">
            <div class="stats-card h-100">
                <small class="text-muted">Total general</small>
                <div class="fs-3 fw-bold">@totalAmount.ToString("C")</div>
            </div>
        </div>
        <div class="col-md-8">
            <div class="row g-3">
                <div class="col-md-4">
                    <form method="get" class="mb-2">
                        <input type="hidden" name="from" value="@fromValue" />
                        <input type="hidden" name="to" value="@toValue" />
                        <input type="hidden" name="customerId" value="@filterCustomer" />
                        <input type="hidden" name="minTotal" value="@minValue" />
                        <input type="hidden" name="maxTotal" value="@maxValue" />
                        <label class="form-label">Filtrar día</label>
                        <select name="daily" class="form-select" onchange="this.form.submit()">
                            <option value="">Todos</option>
                            @foreach (var item in dailyTotals.Take(10))
                            {
                                <option value="@item.Label" selected="@(dailyFilter == item.Label ? "selected" : null)">@item.Label</option>
                            }
                        </select>
                    </form>
                    <ul class="list-unstyled mb-0">
                        @foreach (var item in dailyTotals.Take(5))
                        {
                            <li class="d-flex justify-content-between"><span>@item.Label</span><strong>@item.Total.ToString("C")</strong></li>
                        }
                    </ul>
                </div>
                <div class="col-md-4">
                    <form method="get" class="mb-2">
                        <input type="hidden" name="from" value="@fromValue" />
                        <input type="hidden" name="to" value="@toValue" />
                        <input type="hidden" name="customerId" value="@filterCustomer" />
                        <input type="hidden" name="minTotal" value="@minValue" />
                        <input type="hidden" name="maxTotal" value="@maxValue" />
                        <label class="form-label">Filtrar mes</label>
                        <select name="monthly" class="form-select" onchange="this.form.submit()">
                            <option value="">Todos</option>
                            @foreach (var item in monthlyTotals.Take(10))
                            {
                                <option value="@item.Label" selected="@(monthlyFilter == item.Label ? "selected" : null)">@item.Label</option>
                            }
                        </select>
                    </form>
                    <ul class="list-unstyled mb-0">
                        @foreach (var item in monthlyTotals.Take(5))
                        {
                            <li class="d-flex justify-content-between"><span>@item.Label</span><strong>@item.Total.ToString("C")</strong></li>
                        }
                    </ul>
                </div>
                <div class="col-md-4">
                    <form method="get" class="mb-2">
                        <input type="hidden" name="from" value="@fromValue" />
                        <input type="hidden" name="to" value="@toValue" />
                        <input type="hidden" name="customerId" value="@filterCustomer" />
                        <input type="hidden" name="minTotal" value="@minValue" />
                        <input type="hidden" name="maxTotal" value="@maxValue" />
                        <label class="form-label">Filtrar año</label>
                        <select name="yearly" class="form-select" onchange="this.form.submit()">
                            <option value="">Todos</option>
                            @foreach (var item in yearlyTotals)
                            {
                                <option value="@item.Label" selected="@(yearlyFilter == item.Label ? "selected" : null)">@item.Label</option>
                            }
                        </select>
                    </form>
                    <ul class="list-unstyled mb-0">
                        @foreach (var item in yearlyTotals)
                        {
                            <li class="d-flex justify-content-between"><span>@item.Label</span><strong>@item.Total.ToString("C")</strong></li>
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>
</section>

<form method="get" class="card card-body mb-3">
    <div class="row g-3 align-items-end">
        <div class="col-md-3">
            <label class="form-label">Desde</label>
            <input type="date" name="from" class="form-control" value="@fromValue" />
        </div>
        <div class="col-md-3">
            <label class="form-label">Hasta</label>
            <input type="date" name="to" class="form-control" value="@toValue" />
        </div>
        <div class="col-md-3">
            <label class="form-label">Cliente</label>
            <select name="customerId" class="form-select">
                <option value="">Todos</option>
                @foreach (var c in customers)
                {
                    <option value="@c.Id" selected="@(filterCustomer == c.Id.ToString() ? "selected" : null)">@c.FullName</option>
                }
            </select>
        </div>
        <div class="col-md-1">
            <label class="form-label">Mín.</label>
            <input type="number" name="minTotal" class="form-control" step="0.01" value="@minValue" />
        </div>
        <div class="col-md-1">
            <label class="form-label">Máx.</label>
            <input type="number" name="maxTotal" class="form-control" step="0.01" value="@maxValue" />
        </div>
        <div class="col-md-1 d-flex gap-2">
            <button class="btn btn-primary w-100" type="submit">Filtrar</button>
        </div>
        <div class="col-md-1">
            <a class="btn btn-outline-secondary w-100" asp-action="Index">Limpiar</a>
        </div>
    </div>
</form>
<table class="table table-striped"><thead><tr><th>Fecha</th><th>Cliente</th><th>Total</th><th class="text-end">Acciones</th></tr></thead><tbody>
@foreach(var s in Model){
    <tr>
        <td>@s.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
        <td>@s.Customer?.FullName</td>
        <td>@s.Total.ToString("0.00")</td>
        <td class="text-end">
            <a class="btn btn-sm btn-outline-primary" asp-action="Details" asp-route-id="@s.Id">Ver</a>
            <a class="btn btn-sm btn-outline-secondary" asp-action="Edit" asp-route-id="@s.Id">Editar</a>
            <a class="btn btn-sm btn-outline-danger" asp-action="Delete" asp-route-id="@s.Id">Eliminar</a>
        </td>
    </tr>
} </tbody></table>
