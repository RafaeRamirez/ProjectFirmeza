@{
    ViewData["Title"] = "Chatbot";
}
<div id="chatbot-app" data-endpoint="@Url.Action("Ask", "Chat")">
    <div class="glass-panel p-4 mb-4">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
            <div>
                <span class="pill-badge"><i class="bi bi-stars"></i> Gemini-powered</span>
                <h1 class="hero-heading mt-3">Asistente <span class="hero-highlight">inteligente</span> para tu negocio</h1>
                <p class="text-muted mb-0">Consulta métricas, recibe recomendaciones y documenta conversaciones con la máxima claridad.</p>
            </div>
            <div class="d-flex gap-3">
                <div class="stats-card text-center">
                    <small class="text-muted">Disponibilidad</small>
                    <div class="fs-4 fw-bold text-white">24/7</div>
                </div>
                <div class="stats-card text-center">
                    <small class="text-muted">Satisfacción</small>
                    <div class="fs-4 fw-bold text-white">98%</div>
                </div>
            </div>
        </div>
    </div>

    <div class="chatboard">
        <div class="glass-panel p-4 d-flex flex-column">
            <div class="chat-window" id="chat-window">
                <div class="message-bubble bot">¡Hola! Soy el bot de Soporte Firmeza. ¿En qué puedo ayudarte?</div>
            </div>
            <div class="chat-input-area mt-3">
                <textarea class="form-control mb-3" id="chat-input" rows="3" placeholder="Escribe tu mensaje..."></textarea>
                <div class="d-flex flex-wrap justify-content-end gap-2">
                    <button class="btn btn-outline-secondary" id="chat-clear">Limpiar</button>
                    <button class="btn btn-primary" id="chat-send">Enviar</button>
                </div>
            </div>
        </div>
        <div class="glass-panel p-4">
            <h5 class="fw-semibold">Tips para mejores respuestas</h5>
            <ul class="list-unstyled mt-3 mb-0">
                <li class="mb-3">
                    <strong>Contexto</strong>
                    <p class="text-muted mb-0">Describe la situación del cliente o la venta para que la IA personalice la respuesta.</p>
                </li>
                <li class="mb-3">
                    <strong>Acción deseada</strong>
                    <p class="text-muted mb-0">Indica qué quieres lograr: resumen, plan, respuestas rápidas o ideas.</p>
                </li>
                <li>
                    <strong>Tono</strong>
                    <p class="text-muted mb-0">Pide un estilo (formal, cercano, analítico) y el bot lo mantendrá.</p>
                </li>
            </ul>
            <div class="stats-card mt-4">
                <small class="text-muted">Estado del servicio</small>
                <div class="d-flex align-items-center justify-content-between mt-2">
                    <span>Gemini 1.5 Flash</span>
                    <span class="badge bg-success">Operativo</span>
                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts {
<script>
(function(){
    const endpoint = document.getElementById('chatbot-app').dataset.endpoint;
    const chatWindow = document.getElementById('chat-window');
    const input = document.getElementById('chat-input');
    const sendBtn = document.getElementById('chat-send');
    const clearBtn = document.getElementById('chat-clear');

    function appendMessage(text, owner){
        const bubble = document.createElement('div');
        bubble.className = `message-bubble ${owner}`;
        bubble.textContent = text;
        chatWindow.appendChild(bubble);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    async function sendMessage(){
        const message = input.value.trim();
        if(!message) return;
        appendMessage(message, 'me');
        input.value = '';
        sendBtn.disabled = true;
        appendMessage('Pensando...', 'bot');
        const placeholder = chatWindow.lastElementChild;
        try{
            const res = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message })
            });
            const data = await res.json();
            placeholder.textContent = data.reply ?? 'Sin respuesta.';
        }catch(err){
            placeholder.textContent = 'No pude responder en este momento.';
        }finally{
            sendBtn.disabled = false;
        }
    }

    sendBtn.addEventListener('click', sendMessage);
    input.addEventListener('keydown', e => {
        if(e.key === 'Enter' && !e.shiftKey){
            e.preventDefault();
            sendMessage();
        }
    });
    clearBtn.addEventListener('click', () => {
        chatWindow.innerHTML = '<div class="text-muted">Conversación reiniciada.</div>';
    });
})();
</script>
}
